{{#section 'title'}}
    Form Đăng Bán 
{{/section}}
  
{{#section 'css'}}
     <style>
      /* Remove the navbar's default rounded borders and increase the bottom margin */ 
      .info
      {
      	font-weight: bold;
  	 	font-family: arial;
  	 	font-style: italic;
      }
      .mota
      {
      	font-weight: bold;
  	 	font-family: arial;
  	 	font-style: italic;
  	  }
      .navbar {
        margin-bottom: 50px;
        border-radius: 0;
      }
      
      /* Remove the jumbotron's default bottom margin */ 
       .jumbotron {
        margin-bottom: 0;
      }
      .container-fluid{
        margin-left: 0px;
      }
      .jumbotron.text-center{
        margin-bottom: 20px;
      }
      /* Add a gray background color and some padding to the footer */
      footer {
        background-color: #f2f2f2;
        padding: 25px;
      }
      #upload-input {
        display: none;
      }
      .upload-btn {
        color: #ffffff;
        background-color: #F89406;
        border: none;
      }
    </style>
{{/section}}







	<div class="row">
    <div class="col-sm-12" style="background: white;">

            <div class="row">
            
              <div class="panel panel-primary">
            			<div class="panel-heading">
            			   Thêm Sản Phẩm
            			</div>
            			<div class="panel-body">
                    
                  				<div class="col-md-6">
                                
                          				<form name="frm" method="POST" action="/product/dangsanpham" id="formDangSanPham" >
                                    

                                      <div class="row">
                                        <div class="col-md-6"> 
                                              <label class="control-label" for="tenSanPham">Nhập Tên Sản Phẩm</label>  
                                              <input type="text" class="form-control" id="tenSanPham" name="tenSanPham">
                                              <span style="color:red;" id="error_tenSanPham"><strong></strong></span>
                                        </div>
                                        <div class="col-md-6">
                                              <label class="control-label"  for="loai">Nhập Loại Sản Phẩm</label> 
                                             
                                              <select class="form-control" name="loai" id="loai">
                                               {{#each layoutVM.categories}}
                                                <option>{{tenLoaiSanPham}}</option>
                                               {{/each}}
                                              </select>
                                              <input type="hidden" class="form-control" id="idLoaiSanPham" name="idLoaiSanPham">
                                        </div>
                                      </div></br>

                                      <div class="row">
                                        <div class="col-md-6">
                                              <label class="control-label" for="giakhoidiem" >Nhập Giá Khởi Điểm</label> 
                                              <input type="number" class="form-control" id="giaKhoiDiem" name="giaKhoiDiem" >
                                              <span style="color:red;" id="error_giaKhoiDiem"><strong></strong></span>
                                        </div>
                                        <div class="col-md-6">
                                              <label class="control-label"  for="giamuangay" >Nhập Giá Mua Ngay</label>  
                                              <input type="number" class="form-control" id="giaMuaNgay" name="giaMuaNgay" >
                                              <span style="color:red;" id="error_giaMuaNgay"><strong></strong></span>
                                        </div>
                                      </div></br>

                                      <div class="row">
                                        <div class="col-md-6">
                                              <label class="control-label"  for="buocGia" >Bước giá</label>  
                                              <input type="number" class="form-control" id="buocGia" name="buocGia" >
                                              <span style="color:red;" id="error_buocGia"><strong></strong></span>
                                        </div>
                                        <div class="col-md-6">
                                              <label class="control-label"  for="thoiGianDauGia" >Thời gian đấu giá</label>  
                                              <select class="form-control" name="thoiGianDauGia" id="thoiGianDauGia">
                                                 <option>1 day</option>
                                                 <option>2 days</option>
                                                 <option>3 days</option>
                                                 <option>4 days</option>
                                                 <option>5 days</option>
                                              </select>
                                              <input type="hidden" class="form-control" id="thoiGian" name="thoiGian">
                                        </div>
                                      </div></br> 

                                 
                            				  
                            					
                            					<label class="control-label" for="mota">Nhập Mô Tả</label>	
                            					<textarea type="text" class="form-control" id="moTa" name="moTa"></textarea></br>
                                      <span style="color:red;" id="error_moTa"><strong></strong></span>
                            					<label class="control-label">Chọn Hình Ảnh Cho Sản Phẩm</label><br>
                                      <div class="row">
                                          <div class="col-md-2">
                                              <button class="btn btn-xs btn-success upload-btn" type="button">Upload File</button>
                                             
                                          </div>
                                          <div class="col-md-10">
                                              <div class="progress">
                                                <div class="progress-bar progress-bar-success" role="progressbar">
                                                 
                                                </div>

                                            </div>
                                          </div>
                                          <span style="color:red;" id="error_imageUpload"><strong></strong></span>
                                         
                                          <input id="upload-input" type="file" name="uploads[]" multiple="multiple"></br>
                                      </div>
                                      <br>
                                      <div class="checkbox">
                                        <label><input id="giaHan" name="giaHan" type="checkbox">Tự động gia hạn </label>
                                         <input type="hidden" class="form-control" id="tuDongGiaHan" name="tuDongGiaHan">
                                      </div>
                            					<label class="control-label" for="btnUpload">Click Xem Trước nếu muốn xem lại sản phẩm</label> 
                            					<button type="button" class="btn btn-success" id="btnPreview">Xem Trước</button>
                                      <button type="submit" class="btn btn-success">Đăng Bán</button><br>
                          				</form>

                                  <div class="row" style="margin-top:30px;"> 
                                    <div class="col-md-12" id="extraImages">

                                    </div>
                                  </div>

                              
                          </div>
                            
                  		    <div class="col-md-6" >
                            	 <div class="row" id="xemtruoc">
                               </div>
                          </div>
                        
            		  </div>
          		
          	  </div>


            </div>
    </div>
  </div>
	

  <script src='https://cloud.tinymce.com/stable/tinymce.min.js'></script>		
	<script>

      var dataImageObject;
      var files;
      var isImageFormat;
     
      $(document).ready(function(){
         // alert($('#loai').val());
         files = 0;
         isImageFormat = true;

         tinymce.init({
         selector: '#moTa',
         theme: 'modern',
         
          plugins: [
            'advlist autolink link lists charmap print preview hr anchor pagebreak spellchecker',
            'searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime nonbreaking',
            'save table contextmenu directionality emoticons template paste textcolor'
          ],
          //content_css: 'css/content.css',
          toolbar: 'insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview media fullpage | forecolor backcolor emoticons'
        });
       

      });

      //submit
      $('#formDangSanPham').submit(function(){
        if(validateForm()){
         
          return true;
        } 
        return false;
        
       
        
      });

      

      //btn preview san pham
    	$('#btnPreview').on('click',function()
    	{
        
        //if(!validateForm()) return;
        var tenSanPham = $('#tenSanPham').val();

        var loai = $('#loai').prop('selectedIndex'); //index 0,1,2,3..
        var tenLoaiSanPham = $('#loai').val();

        var giaKhoiDiem = $('#giaKhoiDiem').val();
        var giaMuaNgay = $('#giaMuaNgay').val();
        var buocGia = $('#buocGia').val();

        var thoiGianDauGia = $('#thoiGianDauGia').prop('selectedIndex'); //index 0,1,2,3,..
        var tgdg = $('#thoiGianDauGia').val();

        var moTa = $('#moTa').val();
       
       // alert(url);

        
        var html=      '<div class="panel panel-primary" >'
                            + '<div class="panel-heading">'
                                + '<div class="row">'
                                    + '<div class="col-md-6">'
                                          + '<a href="#"><span style="color:white"><strong>Tên: ' + tenSanPham + '</strong></span></a>'
                                    + '</div>'
                                    + '<div class="col-md-6">'
                                          + '<a href="#"><span style="color:white"><strong>Loại: ' + tenLoaiSanPham + '</strong></span></a>'
                                    + '</div>'
                                + '</div>'
                            + '</div>'
                            + '<div class="panel-body">'
                              + '<div class="row">'  
                                  
                                  + '<div class="row">'
                                    + '<div class="col-md-12 text-center">' 
                                          + '<img src="#" id="sourceImage1" style="width:440px;height:380px;" alt="Image">'   

                                    + '</div>'
                                  + '</div>'
                                  
                                  

                                  + '<div class="row" style="margin-top:20px;">'
                                      + '<div class="col-sm-6 text-center">'
                                            
                                            + '<div class="info">Giá khởi điểm: ' + formatNumber(giaKhoiDiem)+ 'VND </div></br>'
                                            + '<div class="info">Bước giá: '+ formatNumber(buocGia) +'VND </div>'        
                                      + '</div>'
                                      + '<div class="col-sm-6 text-center">'
                                           
                                            + '<div class="info">Giá mua ngay:'+ formatNumber(giaMuaNgay) +'VND </div></br>'
                                            + '<div class="info">Thời gian : '+ tgdg + '</div>' 
                                      + '</div>'
                                  + '</div>'
                              + '</div>'
                            + '</div>' 
                            + '<div class="panel-footer text-center"> <div class="mota" > Mô tả: '+ moTa +'</div>'
                     + '</div>';
                    
          
        $('#xemtruoc').html(html);

        var html=  '<div class="panel panel-primary">'
                        +'<div class="panel-heading">'
                            +'Hình Khác'
                        +'</div>'
                        +'<div class="panel-body>'
                          +'<div class="row">' 
                            +'<div class="col-md-6">' 
                              +'<img src="#" id="sourceImage2" style="width:210px;height:150px;">'
                            +'</div>'
                            +'<div class="col-md-6">' 
                              +'<img src="#" id="sourceImage3" style="width:210px;height:150px;">'
                            +'</div>'
                          +'</div>' 

                        +'</div>'

                     +'</div>'; 
          $('#extraImages').html(html);

         for(var i = 0; i < dataImageObject.files.length; i++){
            readURL(dataImageObject.files[i],i);
          }               
      });


      //doc url cho viec xem trước
     


      function validateForm() {
        tinyMCE.triggerSave();
        var tenSanPham = $('#tenSanPham').val();
        var loai = $('#loai').prop('selectedIndex') + 1; //index 0,1,2,3.. 
        var giaKhoiDiem = $('#giaKhoiDiem').val();
        var giaMuaNgay = $('#giaMuaNgay').val();
        var buocGia = $('#buocGia').val();
        var thoiGianDauGia = $('#thoiGianDauGia').prop('selectedIndex') + 1; //index 0,1,2,3,..
        var moTa = frm.moTa.value;
        if(tenSanPham=="" || tenSanPham.length < 10 || tenSanPham.length > 60){
          $('#error_tenSanPham').text("Tên sản phẩm phải từ 10 - 59 ký tự");
          return false;
        }else $('#error_tenSanPham').text("");

        if(giaKhoiDiem == "" || parseInt(giaKhoiDiem) < 50000) {
          $('#error_giaKhoiDiem').text("Giá khởi điểm ít nhất 50000");
          return false;
        }else $('#error_giaKhoiDiem').text("");

        if(giaMuaNgay == "" || parseInt(giaMuaNgay) < 50000 ) {
          $('#error_giaMuaNgay').text("Giá mua ngay ít nhất 50000");
          return false;
        }else $('#error_giaMuaNgay').text("");

        if(buocGia == "" || parseInt(buocGia) < 10000) {
          $('#error_buocGia').text("Bước giá ít nhất 10000");
          return false;
        }else $('#error_buocGia').text("");

        if(parseInt(giaKhoiDiem) >= parseInt(giaMuaNgay)){
          $('#error_giaMuaNgay').text("Giá mua ngay không được nhỏ hơn giá khởi điểm");
          return false;
        }else $('#error_giaMuaNgay').text("");

        if(((parseInt(giaMuaNgay) - parseInt(giaKhoiDiem)) % parseInt(buocGia))!=0 ){
          $('#error_buocGia').text("Hiệu Giá Mua Ngay và Giá Khởi Điểm phải là bội của bước giá");
          return false;
        }else $('#error_buocGia').text("");

        if(files === 0){
          $('#error_imageUpload').text("Chưa có hình ảnh cho sản phẩm");
          return false;
        }else  $('#error_imageUpload').text("");

        if(files.length==0 ){
          $('#error_imageUpload').text("Chưa có hình ảnh cho sản phẩm");
          return false;
        }else  $('#error_imageUpload').text("");

        if(isImageFormat==false){
         $('#error_imageUpload').text("Vui lòng chọn hình đúng format (.jpg, .png, .gif)");
          return false;
        }else  $('#error_imageUpload').text("");
        if(moTa==""){
         $('#error_moTa').text("Vui lòng nhập mô tả cho sản phẩm");
              return false;
        }else  $('#error_moTa').text("");

        $('#tuDongGiaHan').val($('#giaHan').is(":checked"));
        $('#idLoaiSanPham').val(loai);
        $('#thoiGian').val(thoiGianDauGia);

        return true;

      }

      function formatNumber(num){
        var n = num.toString(), p = n.indexOf('.');
        return n.replace(/\d(?=(?:\d{3})+(?:\.|$))/g, function($0, i){
            return p<0 || i<p ? ($0+',') : $0;
        });
      }

      $('.upload-btn').on('click', function (){
          $('#upload-input').click();
          $('.progress-bar').text('0%');
          $('.progress-bar').width('0%');
      });

      $("#upload-input").change(function(){
        //alert(this.files);
          dataImageObject = this; 
          files = $(this).get(0).files;
          for(var i = 0; i < files.length; i++)
          {
            var format = files[i].name.split(".")[1];
            if((format != 'jpg') && (format!= 'png' ) && (format!= 'gif') && (format!="bmp")){
              alert("Invalid Format Supported By HTML5");
              isImageFormat = false;
              return 0;
            }
          }
          isImageFormat = true;
          completeUpload();

      });
      
      function completeUpload(){
         if (files.length > 0)
          {
              // One or more files selected, process the file upload

              // create a FormData object which will be sent as the data payload in the
              // AJAX request
              var formData = new FormData();

              // loop through all the selected files
              for (var i = 0; i < files.length; i++)
              {
                    var file = files[i];
                    // add the files to formData object for the data payload
                    formData.append('uploads[]', file, file.name); 
              }

             
              //end create FormData
              //start Ajax
              $.ajax({

                      url: '/product/upload',
                      type: 'POST',
                      data: formData,
                      processData: false,
                      contentType: false,
                      success: function(data){
                          console.log('upload successful!');
                      }, //start xhr update progress
                      xhr: function() {
                        // create an XMLHttpRequest
                        var xhr = new XMLHttpRequest();

                        // listen to the 'progress' event
                        xhr.upload.addEventListener('progress', function(evt) {

                          if (evt.lengthComputable) {
                            // calculate the percentage of upload completed
                            var percentComplete = evt.loaded / evt.total;
                            percentComplete = parseInt(percentComplete * 100);

                            // update the Bootstrap progress bar with the new percentage
                            $('.progress-bar').text(percentComplete + '%');
                            $('.progress-bar').width(percentComplete + '%');

                            // once the upload reaches 100%, set the progress bar text to done
                            if (percentComplete === 100) {
                              $('.progress-bar').html('Done');
                            }

                          }

                        }, false);

                        return xhr;
                      }
                    

              });
              //end ajax
          } 
      }
     
      
      //update progress bar
      


      function readURL(input, pos) {
          alert(input);
          if (input) {

              var reader = new FileReader();

              reader.onload = function (e) {
                if(pos==0)
                   $('#sourceImage1').attr('src', e.target.result);
                if(pos==1)
                   $('#sourceImage2').attr('src', e.target.result);
                if(pos==2)
                   $('#sourceImage3').attr('src', e.target.result);
              }

              reader.readAsDataURL(input);

          }
      }


	</script>


